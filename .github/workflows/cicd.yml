name: Resume Ranking Workflow

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    types: [opened]
    branches:
      - main

jobs:
  # =========================
  # üì¶ Installation & Setup
  # =========================
  installation:
    name: Setup & Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cache npm modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

  # =========================
  # üß† Algorithm Tests
  # =========================
  algorithms-direct-scoring:
    name: Test Direct Scoring Service
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/algorithms/scoring/direct-scoring-service.test.ts

  algorithms-real-scoring:
    name: Test Real Scoring Service
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/algorithms/scoring/real-scoring-service.test.ts

  algorithms-skill-matcher:
    name: Test Skill Matcher
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/algorithms/skill-matching/skill-matcher.test.ts

  # =========================
  # üìÑ Page Navigation Tests
  # =========================
  pages-rankings-navigation:
    name: Test Rankings Creation Navigation
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/pages/rankings-create/navigation/ranking-steps-navigation.test.tsx

  pages-video-navigation:
    name: Test Video Call Navigation
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/pages/video-call/navigation/video-call-nav.test.tsx

  # =========================
  # ‚úâÔ∏è Communication Tests
  # =========================
  communication-email:
    name: Test Email Templates
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/communication/email-templates.test.tsx

  # =========================
  # üßÆ Data Processing Tests
  # =========================
  data-duplicate-detection:
    name: Test Duplicate Detection
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/data-processing/duplicate-detection.test.ts

  data-resume-parser:
    name: Test Resume Parser
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/data-processing/resume-parser.test.ts
  
  # =========================
  # ‚ö° Realtime Tests
  # =========================
  realtime-connection:
    name: Test Connection Manager
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/realtime/connection-manager.test.ts

  # =========================
  # üõ†Ô∏è Utilities Tests
  # =========================
  utilities:
    name: Test Utilities
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/utilities/utils.test.ts

  # =========================
  # ‚¨áÔ∏è Additional Unit Tests
  # =========================
  additional-unit:
    name: Test Additional Unit Tests
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/additional/unit

  # =========================
  # üß™ Extended Tests
  # =========================
  extended-edge-cases:
    name: Test Edge Cases
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/extended/edge-cases

  extended-error-handling:
    name: Test Error Handling
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/extended/error-handling

  extended-validation:
    name: Test Validation
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/extended/validation

  extended-security:
    name: Test Security
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/extended/security

  API-Auth:
    name: Test Auth API
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      # run all tests in auth/api folder (adjust filename if you want a specific test file)
      - run: npm test -- __tests__/auth/api

  Auth-Components:
    name: Test Auth Components
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      # corrected folder name (was 'compoents' typo)
      - run: npm test -- __tests__/auth/components

  Auth-Integration-Test:
    name: Test Auth Integration
    needs: [installation]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - run: npm ci
      - run: npm test -- __tests__/auth/integration

# ... (all your existing test jobs)

# =========================
# üì¶ Build Artifact & Store
# =========================
  build-artifact:
    name: Build Production Artifact
    # This job runs only if ALL your testing jobs succeed
    needs: 
      # List all your test jobs here to ensure they pass first
      - algorithms-direct-scoring
      # ... (all other test jobs)
      - Auth-Integration-Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4 # Use v4 for better compatibility
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies and Build
        run: |
          npm ci
          npm run build

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: resume-ranking-production-build # A descriptive name for the file
          path: build/ # This is the folder containing your static React files
          retention-days: 7 # Optional: How long GitHub should store the file  

  # =========================
  # üìä Test Summary
  # =========================
  test-summary:
    name: Test Summary
    needs:
      - algorithms-direct-scoring
      - algorithms-real-scoring
      - algorithms-skill-matcher
      - pages-rankings-navigation
      - pages-video-navigation
      - communication-email
      - data-duplicate-detection
      - data-resume-parser
      - realtime-connection
      - utilities
      - additional-unit
      - extended-edge-cases
      - extended-error-handling
      - extended-validation
      - extended-security
      - API-Auth
      - Auth-Components
      - Auth-Integration-Test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: All Tests Complete
        run: echo "All test suites have completed (or at least attempted)!"
